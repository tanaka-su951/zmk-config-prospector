# ZMK ãƒ“ãƒ«ãƒ‰ã®ãŸã‚ã®å®Œå…¨æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# å¤–éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾å­˜ã›ãšã€ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’æ‰‹å‹•ã§è¨­å®šã—ã¾ã™ã€‚
name: Build ZMK Firmware (Full Manual Setup)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # ã™ã¹ã¦ã®ç’°å¢ƒå¤‰æ•°ã‚’ã“ã“ã§å®šç¾©ã—ã€å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§å†åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
    env:
      ZMK_CONFIG: ${{ github.workspace }}
      
    steps:
      - name: Checkout ZMK Config
        uses: actions/checkout@v4
        # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ãŸã‚ã€ç„¡åŠ¹ã«ã—ã¾ã™
        with:
          submodules: false
          fetch-depth: 0

      - name: ğŸ› ï¸ Setup Environment and Tools (Manual)
        id: setup_tools
        run: |
          echo "--- 1. Set environment variables ---"
          # Zephyr SDKã®ãƒ‘ã‚¹ã‚’æ‰‹å‹•ã§è¨­å®šã—ã¾ã™ (GitHub Actionsã®æ¨™æº–ãƒ‘ã‚¹)
          # æ³¨: runners-latestã‚¤ãƒ¡ãƒ¼ã‚¸ã«å­˜åœ¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
          echo "ZEPHYR_SDK_INSTALL_DIR=/home/runner/zephyr-sdk-0.16.5" >> $GITHUB_ENV
          
          # ãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "--- 2. Install Python Dependencies ---"
          pip install west cmake ninja 
          
          # CMakeãŒZMKã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã€ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
          echo "--- 3. Create ZMK-App Symlink (Required for West) ---"
          mkdir -p zmk/app
          # west initãŒå¤±æ•—ã—ãªã„ã‚ˆã†ã€ãƒ€ãƒŸãƒ¼ã®west.ymlã‚’ä½œæˆ
          echo "manifest:" > zmk/app/west.yml
          
          # ZMKã‚³ã‚¢ã‚’å¼·åˆ¶çš„ã«ã‚¯ãƒ­ãƒ¼ãƒ³ (å¤–éƒ¨ä¾å­˜ã‚¨ãƒ©ãƒ¼ã®å›é¿)
          echo "--- 4. Force Clone ZMK Core ---"
          git clone --depth 1 https://github.com/zmkfirmware/zmk.git zmk_core_repo
          
          # ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’zmk/appã«ç§»å‹•
          echo "--- 5. Configure ZMK/West structure (FIXED) ---"
          # ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã£ãŸ 'zmk_core_repo/west.yml' ã®ç§»å‹•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ
          mv zmk_core_repo/app/* zmk/app/
          rm -rf zmk_core_repo
          
          # ZMKã®Pythonè¦ä»¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆZMKã®requirements.txtã‚’ä½¿ç”¨ï¼‰
          pip install -r zmk/app/requirements.txt || true 

      - name: ğŸŒ Initialize and Update ZMK Workspace (West)
        id: west_init_update
        run: |
          echo "--- 1. Clean up old artifacts and run west init ---"
          if [ -d ".west" ]; then rm -rf .west; fi
          # ãƒ«ãƒ¼ãƒˆã®west.ymlã‚’ä½¿ã£ã¦åˆæœŸåŒ–ã—ã¾ã™ (ã‚ãªãŸã®ãƒªãƒã‚¸ãƒˆãƒªã®west.ymlã‚’ä½¿ç”¨)
          west init -l . 
          
          echo "--- 2. West update to fetch Zephyr and Modules ---"
          # ã“ã“ã§west.ymlã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å…¨ä¾å­˜é–¢ä¿‚ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
          west update
          
          echo "--- 3. Set Toolchain Environment (Final Check) ---"
          # westãŒæ­£ã—ãç’°å¢ƒã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«å¼·åˆ¶çš„ã«å®Ÿè¡Œ
          source "$HOME/.local/bin/activate" || true
          
      - name: âš™ï¸ Build ZMK Firmware
        run: |
          echo "--- Start Final Build Command ---"
          
          # ZMKã®æ¨å¥¨ã‚³ãƒãƒ³ãƒ‰ã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
          west build -s zmk/app -d build -b seeeduino_xiao_ble \
            -- -DSHIELD=prospector_scanner \
            -DZMK_CONFIG=$ZMK_CONFIG

      - name: ğŸ“¦ Archive Firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BOARD }}-firmware
          path: build/zephyr/zmk.uf2

          
      - name: âš™ï¸ Build ZMK Firmware
        run: |
          echo "--- Start Final Build Command ---"
          
          # ZMKã®æ¨å¥¨ã‚³ãƒãƒ³ãƒ‰ã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
          # -S: ã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (zmk/app)
          # -d: ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (build)
          # -b: ãƒœãƒ¼ãƒ‰å
          # -- : CMakeã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åŒºåˆ‡ã‚Šæ–‡å­—
          # -DSHIELD: ã‚·ãƒ¼ãƒ«ãƒ‰å
          # -DZMK_CONFIG: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ã‚‹å ´æ‰€
          west build -s zmk/app -d build -b seeeduino_xiao_ble \
            -- -DSHIELD=prospector_scanner \
            -DZMK_CONFIG=$ZMK_CONFIG

      - name: ğŸ“¦ Archive Firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BOARD }}-firmware
          path: build/zephyr/zmk.uf2
