# ZMKãƒ“ãƒ«ãƒ‰ã®æœ€çµ‚å®‰å®šç‰ˆã€‚ãƒ›ã‚¹ãƒˆOSã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’å®Œäº†ã•ã›ã¦ã‹ã‚‰Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

name: Build ZMK Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
    defaults:
      run:
        working-directory: ${{ github.workspace }}
        
    # ãƒ›ã‚¹ãƒˆOSã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’å‡¦ç†
    runs-on: ubuntu-latest
    
    # Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
    container: zmkfirmware/zmk-build-arm:stable
    
    strategy:
      matrix:
        board: [seeeduino_xiao_ble]
        shield: [prospector_scanner]
        
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¨ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          path: config # ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ 'config' ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

      # 2. westãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ˜ç¤ºçš„ã«åˆæœŸåŒ–ã—ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–° (west.ymlã‚’ãƒ«ãƒ¼ãƒˆã«ç§»å‹•)
      - name: Initialize and Update ZMK modules
        working-directory: config
        run: |
          # ğŸ’¥ æœ€çµ‚ãƒ‘ã‚¹ä¿®æ­£: west.ymlã‚’ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œå‰ã«ãƒ«ãƒ¼ãƒˆã«æˆ»ã™
          mv west.yml ..
          cd ..
          # éå»ã®ä¸å®Œå…¨ãªZMKã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -rf zmk
          west init -l .
          west update --rebase
          # ğŸ’¥ è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒå®‰å®šã™ã‚‹ã®ã‚’å¾…ã¤
          sleep 5
        
      # 3. ZMKãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ãƒ“ãƒ«ãƒ‰
      # ğŸ’¥ æœ€çµ‚ä¿®æ­£: west updateã®å®Ÿè¡Œå ´æ‰€ãŒãƒ«ãƒ¼ãƒˆã«ãªã£ãŸãŸã‚ã€ãƒ“ãƒ«ãƒ‰ã‚‚ãƒ«ãƒ¼ãƒˆã§è¡Œã†
      - name: Build ZMK firmware
        run: west build -s zmk/app -p -b ${{ matrix.board }} -- -DSHIELD=${{ matrix.shield }}

      # 4. ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      - name: Archive firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-seeeduino_xiao_ble
          # ãƒ“ãƒ«ãƒ‰çµæœã®ãƒ‘ã‚¹ã‚’ build/zephyr/zephyr.uf2 ã«æˆ»ã—ã¾ã™ (ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‘ã‚¹)
          path: build/zephyr/zephyr.uf2
