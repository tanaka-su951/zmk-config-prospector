# ZMK Custom Config Build Workflow (å¤–éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ä¾å­˜ã®æ’é™¤)

name: Build ZMK Firmware (Single-Step)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ZMK Config
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0

    - name: --- ğŸš€ ZMKç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ãƒ“ãƒ«ãƒ‰ (å˜ä¸€ã‚¹ãƒ†ãƒƒãƒ—) ğŸš€ ---
      run: |
        # 1. ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ« (west) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        echo "--- 1. Installing West ---"
        pip install west
        
        # 2. ZMKã‚³ã‚¢ã‚’æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ãƒ³ (west updateã®å¤±æ•—ã‚’å›é¿)
        echo "--- 2. Cloning ZMK Core ---"
        git clone --depth 1 https://github.com/zmkfirmware/zmk zmk
        
        # 3. west init ã¨ west update ã‚’å®Ÿè¡Œã—ã€Zephyrã¨ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
        echo "--- 3. Running west init and update ---"
        west init -l .
        west update
        
        # 4. ZMK Pythonè¦ä»¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        echo "--- 4. Installing Python Dependencies ---"
        pip install -r zmk/requirements.txt || true
        
        # 5. Toolchainï¼ˆARM GCCï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        # west zephyr-exportã«ä»£ã‚ã‚‹å‡¦ç†: westãŒToolchainã®å ´æ‰€ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã«å¿…è¦
        echo "--- 5. Installing Toolchain ---"
        west zephyr-export
        
        # 6. ZMK Firmwareã‚’ãƒ“ãƒ«ãƒ‰
        # ã™ã¹ã¦ãŒåŒã˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã¯æœ‰åŠ¹ã§ã™
        echo "--- 6. Running ZMK Build ---"
        west build -s zmk/app -d build \
          -b seeeduino_xiao_ble \
          -- -DSHIELD=prospector_scanner \
          -DZMK_CONFIG=$GITHUB_WORKSPACE
          
        # ãƒ“ãƒ«ãƒ‰æˆæœç‰© (uf2ãƒ•ã‚¡ã‚¤ãƒ«) ã®ç¢ºèª
        if [ -f "build/zephyr/zmk.uf2" ]; then
          echo "âœ… Build Successful! Firmware path: build/zephyr/zmk.uf2"
        else
          echo "âŒ FATAL: ZMK firmware file not found after build."
          exit 1
        fi

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: build/zephyr/zmk.uf2
