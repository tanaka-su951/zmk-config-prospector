name: Build Prospector Firmware (Board Test Only)

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      # ZMK ツールチェーンがプリインストールされた安定の Docker Hub イメージを使用
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root

    steps:
      # 1. ディスク容量のクリーンアップ (安定のため)
      - name: Free Disk Space (Custom)
        run: |
          echo "Removing large packages and caches to free space..."
          rm -rf /usr/local/lib/android
          rm -rf /usr/share/dotnet
          apt clean
          rm -rf /var/lib/apt/lists/*
        shell: bash

      # 2. ZMK と設定をチェックアウト
      - name: Checkout Custom Config
        uses: actions/checkout@v4
        with:
          path: config
      
      - name: Checkout ZMK Repository
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: main 
          path: zmk

      # 3. west 初期化、アップデート、環境変数設定
      - name: Initialize West and Update Modules
        run: |
          CONFIG_DIR="config"

          echo "=== 1. Setup west workspace and west.yml ==="
          
          # west.yml を作成
          cat << EOF > $CONFIG_DIR/west.yml
          manifest:
            remotes:
              - name: zmkfirmware
                url-base: https://github.com/zmkfirmware
            projects:
              - name: zmk
                remote: zmkfirmware
                revision: main
                import: app/west.yml
            self:
              path: config
          EOF

          west init -l $CONFIG_DIR
          west update
          
          echo "=== 2. Export ZMK_CONFIG Path ==="
          echo "ZMK_CONFIG=$PWD/$CONFIG_DIR" >> $GITHUB_ENV
          
        shell: bash

      # 4. ビルド実行とすべてのパスの強制注入
      - name: Perform ZMK Build (BOARD ONLY Test)
        run: |
          export ZMK_CONFIG="$ZMK_CONFIG" 
          
          # ★★★ 修正: zephyr-env.sh の存在チェックと絶対パス参照 ★★★
          ZEPHYR_ENV_SCRIPT="$PWD/zephyr/zephyr-env.sh"
          
          if [ -f "$ZEPHYR_ENV_SCRIPT" ]; then
              echo "Zephyr environment script found. Sourcing..."
              source "$ZEPHYR_ENV_SCRIPT"
          else
              echo "FATAL: zephyr/zephyr-env.sh not found. Displaying current directory contents for debug."
              ls -l $PWD/ # 現在のディレクトリ内容を表示
              ls -l $PWD/zephyr # zephyr ディレクトリ内の内容を表示
              exit 1
          fi
          
          # パス計算
          ZEPHYR_CMAKE_DIR="$PWD/zephyr/share/zephyr-package/cmake"
          ZEPHYR_ROOT_DIR="$PWD/zephyr"
          TOOLCHAIN_VARIANT="gnuarmemb"
          TOOLCHAIN_PATH="/opt/toolchains/gnuarmemb"
          
          echo "=== Starting ZMK Build (Testing Base Board) ==="
          
          # シールド設定なしで、ボード単体のビルドを試行
          west build -s zmk/app -b seeeduino_xiao_ble -d build/board_only_test -- \
            -DZephyr_DIR="$ZEPHYR_CMAKE_DIR" \
            -DZEPHYR_BASE="$ZEPHYR_ROOT_DIR" \
            -DZEPHYR_TOOLCHAIN_VARIANT="$TOOLCHAIN_VARIANT" \
            -DGNUARMEMB_TOOLCHAIN_PATH="$TOOLCHAIN_PATH"
          
          echo "=== Test Complete ==="

          # ビルドが成功したかどうかの確認
          BIN_PATH="build/board_only_test/zephyr/zephyr.elf"
          if [ -f "$BIN_PATH" ]; then
            echo "SUCCESS: Base board build passed. The issue is in the custom shield files."
            python3 zmk/tools/uf2conv.py "$BIN_PATH" -c -o "build/board_only_test/zephyr.uf2"
          else
            echo "FATAL: Base board build failed. The issue is likely in the ZMK code base or board definition."
            exit 1
          fi
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        uses: actions/upload-artifact@v4
        with:
          name: seeeduino_xiao_ble-base-firmware
          path: build/board_only_test/zephyr.uf2
