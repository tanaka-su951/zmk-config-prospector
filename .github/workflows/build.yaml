name: Build ZMK Firmware (Official Action Final)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 環境変数を定義
    env:
      BOARD: seeeduino_xiao_ble
      SHIELD: prospector_scanner
      ZMK_STABLE_TAG: 3.5.0 # 🚨 タグ名を 3.5.0 に設定 (修正済み) 🚨

    steps:
    - name: Checkout ZMK Config (Your Repo)
      uses: actions/checkout@v4
      with:
        # ZMKコアをサブモジュールとして取得するために必須
        submodules: recursive 
        fetch-depth: 0

    - name: Set up Zephyr/ZMK Build Environment
      # 🚨 このアクションが、Gitクローン、west init/update、SDKセットアップを全て自動で処理します 🚨
      uses: zmkfirmware/zmk-build-action@v2
      with:
        # ZMKコアのバージョンを指定
        ref: ${{ env.ZMK_STABLE_TAG }} 

    - name: Run West Build
      run: |
        echo "--- west build実行 ---"
        # 公式アクションの環境下では、コマンドは非常にシンプル
        west build -b ${{ env.BOARD }} -- -DSHIELD=${{ env.SHIELD }}

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ env.BOARD }}-${{ env.SHIELD }}
        path: build/zephyr/zmk.uf2
        retention-days: 7
