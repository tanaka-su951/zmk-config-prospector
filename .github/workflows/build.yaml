name: Build Prospector Firmware (Final Solution - Stable ZMK)

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      # ZMK ツールチェーンがプリインストールされた安定の Docker Hub イメージを使用
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root

    steps:
      # 1. クリーンアップとチェックアウト
      - name: Free Disk Space (Custom)
        run: |
          rm -rf /usr/local/lib/android /usr/share/dotnet
          apt clean
          rm -rf /var/lib/apt/lists/*
        shell: bash

      - name: Checkout Custom Config
        uses: actions/checkout@v4
        with:
          path: config

      - name: Checkout ZMK Repository (Stable Version)
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          # ★★★ 修正: 安定版のタグに切り替え (v3.6.0 は例として使用) ★★★
          ref: v3.6.0 
          path: zmk

      # 2. west 初期化と依存関係の解決
      - name: Initialize West and Update Modules (Standard ZMK Flow)
        run: |
          CONFIG_DIR="config"
          cat << EOF > $CONFIG_DIR/west.yml
          manifest:
            remotes:
              - name: zmkfirmware
                url-base: https://github.com/zmkfirmware
            projects:
              - name: zmk
                remote: zmkfirmware
                # リビジョンは git clone 済みのため省略可能だが、一応記載
                revision: v3.6.0
                import: app/west.yml
            self:
              path: config
          EOF
          west init -l $CONFIG_DIR
          west update
          echo "ZMK_CONFIG=$PWD/$CONFIG_DIR" >> $GITHUB_ENV
          echo "ZEPHYR_BASE=$PWD/zephyr" >> $GITHUB_ENV
        shell: bash

      # 3. ビルド実行と環境の初期化 (パス注入は維持)
      - name: Perform ZMK Build (Final Build)
        run: |
          export ZMK_CONFIG="$ZMK_CONFIG" 
          export ZEPHYR_BASE="$ZEPHYR_BASE"

          ZEPHYR_ENV_SCRIPT="$ZEPHYR_BASE/zephyr-env.sh"
          source "$ZEPHYR_ENV_SCRIPT"

          # CMAKE_PREFIX_PATH を明示的に設定 (環境安定化のため維持)
          ZEPHYR_CMAKE_DIR="$ZEPHYR_BASE/share/zephyr-package/cmake"
          export CMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH:$ZEPHYR_CMAKE_DIR"
          export GNUARMEMB_TOOLCHAIN_PATH="/opt/toolchains/gnuarmemb"


          echo "=== Starting ZMK Build ==="
          
          rm -rf build/final_attempt

          # west build をシンプルな形で実行
          west build -s zmk/app -b seeeduino_xiao_ble -d build/final_attempt
          
          echo "=== Convert and Finalize ==="

          BIN_PATH="build/final_attempt/zephyr/zephyr.elf"
          if [ -f "$BIN_PATH" ]; then
            echo "SUCCESS: Build completed! Converting to UF2..."
            python3 zmk/tools/uf2conv.py "$BIN_PATH" -c -o "build/final_attempt/zephyr.uf2"
          else
            echo "FATAL: Build failed. Check logs for compile errors."
            exit 1
          fi
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        uses: actions/upload-artifact@v4
        with:
          name: seeeduino_xiao_ble-final-firmware
          path: build/final_attempt/zephyr.uf2
