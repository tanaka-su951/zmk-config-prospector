name: Build Prospector Firmware (Docker Hub Template)

on: [push, pull_request, workflow_dispatch]

# permissions block is no longer strictly necessary, but doesn't hurt. 
# We remove it for a clean sweep back to the simplest working state.

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable # Switched to Docker Hub
      options: --user root

    steps:
      # Disk cleanup re-added for stability
      - name: Free Disk Space (Custom)
        run: |
          echo "Removing large packages and caches to free space..."
          rm -rf /usr/local/lib/android
          rm -rf /usr/share/dotnet
          apt clean
          rm -rf /var/lib/apt/lists/*
          echo "Disk space freed."
        shell: bash
      
      - name: Checkout Custom Config
        uses: actions/checkout@v4
        with:
          path: config

      - name: Perform ZMK Build
        run: |
          CONFIG_DIR="config"
          
          echo "=== Export ZMK_CONFIG Path ==="
          # ZMK_CONFIG is required for the build system to find your custom shield
          export ZMK_CONFIG="$PWD/$CONFIG_DIR"
          
          # Environment variables and paths (like /opt/zmk) are assumed to be set 
          # correctly within the official ZMK container image.
          
          echo "=== Starting ZMK Build ==="
          # Build against the source code present at /opt/zmk/app inside the container
          west build -s /opt/zmk/app -b seeeduino_xiao_ble -d build/prospector_scanner -- \
            -DSHIELD=prospector_scanner
          
          echo "=== Convert and Finalize ==="

          BIN_PATH="build/prospector_scanner/zephyr/zephyr.elf"
          UF2_PATH="build/prospector_scanner/zmk.uf2"

          if [ -f "$BIN_PATH" ]; then
            echo "Converting ELF â†’ UF2"
            # Use the Python toolchain located inside the container
            python3 /opt/zmk/tools/uf2conv.py "$BIN_PATH" -c -o "$UF2_PATH"
          else
            echo "FATAL: Build failed, zephyr.elf not found."
            ls -R build/prospector_scanner
            exit 1
          fi
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-seeeduino_xiao_ble-zmk
          path: build/prospector_scanner/zmk.uf2
