# ZMKファームウェア ビルドワークフロー (環境の不安定性を回避する最終版)

name: Build ZMK Firmware (Final Attempt)

on:
  push:
    branches: [ main ]
    
  pull_request:
    branches: [ main ]
    
  workflow_dispatch:

jobs:
  build:
    # ワークフロー全体でデフォルトの作業ディレクトリを設定 (ルートを指定)
    defaults:
      run:
        working-directory: ${{ github.workspace }}
        
    runs-on: ubuntu-latest
    
    # ZMKビルド用Dockerコンテナを使用
    container: zmkfirmware/zmk-build-arm:stable
    
    strategy:
      matrix:
        board: [seeeduino_xiao_ble]
        shield: [prospector_scanner]
        
    steps:
      # 1. ユーザー設定リポジトリのクローン
      - name: Checkout user configuration
        uses: actions/checkout@v4
        with:
          submodules: false # west.ymlに頼らないため
          
      # 2. ZMKとZephyrのソースコードの手動クローンと環境設定
      - name: Manual ZMK/Zephyr Setup and Build Environment
        # すべてのコマンドを単一のシェルで実行し、パスの問題を回避
        run: |
          # ----------------------------------------------------
          # A. ZMKとZephyrの依存関係をすべて手動でクローン (west.ymlを無視)
          # ----------------------------------------------------
          
          # ZMK本体をクローン
          echo "Cloning ZMK..."
          git clone https://github.com/zmkfirmware/zmk.git
          cd zmk
          # zmk/west.ymlを使って依存関係を更新
          west init -l .
          west update --rebase
          cd ..
          
          # ----------------------------------------------------
          # B. ZEPHYR_BASE 環境変数の強制設定
          # ----------------------------------------------------
          
          # ZMKの west update により、zephyrは 'zmk/zephyr' にあるはず
          ZEPHYR_BASE_PATH=$(pwd)/zmk/zephyr
          echo "ZEPHYR_BASE set to: $ZEPHYR_BASE_PATH"
          
          # 後続の west build のために環境変数をエクスポート (重要)
          echo "ZEPHYR_BASE=$ZEPHYR_BASE_PATH" >> $GITHUB_ENV
          
          # ----------------------------------------------------
          # C. ZMKファームウェアのビルドを実行
          # ----------------------------------------------------
          
          echo "Starting west build..."
          # west build のソースディレクトリを明示的に指定
          west build -s zmk/app -p -b ${{ matrix.board }} -- -DSHIELD=${{ matrix.shield }}
        
      # 3. Archive firmware
      - name: Archive firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.shield }}-${{ matrix.board }}
          # ビルド成果物はルートの 'build' フォルダに出力される
          path: build/zephyr/zephyr.uf2
