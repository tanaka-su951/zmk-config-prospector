# ZMK Custom Config Build Workflow (Zephyr SDK æ‰‹å‹•è¨­å®š)

name: Build ZMK Firmware (Manual SDK Setup)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ZMK Config
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0

    - name: Setup Build Environment (West, Python)
      run: pip install west

    - name: --- ğŸš¨ ZMK ã‚³ã‚¢ã®æ‰‹å‹•ã‚¯ãƒ­ãƒ¼ãƒ³ã¨åˆæœŸåŒ– ğŸš¨ ---
      run: |
        # éå»ã®å¤±æ•—ã§æ®‹ã•ã‚ŒãŸwestè¨­å®šã¨ZMKãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
        echo "--- DEBUG: Cleaning up old artifacts ---"
        rm -rf .west zmk
        
        # ZMKã‚³ã‚¢ãƒªãƒã‚¸ãƒˆãƒªã‚’æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ãƒ³ (ã‚¯ãƒ­ãƒ¼ãƒ³å¤±æ•—å›é¿ã®ãŸã‚)
        echo "--- DEBUG: Cloning ZMK Core ---"
        git clone --depth 1 https://github.com/zmkfirmware/zmk zmk
        
        # west initã¨west updateã‚’å®Ÿè¡Œã—ã€Zephyrã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
        echo "--- Running west init and update ---"
        west init -l .
        west update
        
        if [ ! -d "zmk/app" ]; then
          echo "FATAL: ZMK/APP is still missing after forced clone and west update."
          exit 1
        fi
        
    - name: Setup Zephyr Toolchain
      # ğŸš¨ ZMKãƒ“ãƒ«ãƒ‰ã®éµ: Zephyr SDKã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ç’°å¢ƒè¨­å®š
      run: |
        # å¿…è¦ãªSDKã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        west zephyr-export
        
        # SDKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (v0.16.1ã‚’ä½¿ç”¨)
        wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.1/zephyr-sdk-0.16.1_linux-x86_64.tar.xz -O zephyr-sdk.tar.xz
        
        # è§£å‡
        mkdir zephyr-sdk
        tar -xf zephyr-sdk.tar.xz -C zephyr-sdk --strip-components=1
        
        # SDKã®åˆæœŸåŒ–ã¨ç’°å¢ƒå¤‰æ•°è¨­å®š
        # ã“ã® setup.sh ã‚³ãƒãƒ³ãƒ‰ãŒã€CMakeã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã—ã¾ã™ã€‚
        zephyr-sdk/setup.sh -h

    - name: Install ZMK Python Dependencies
      # SDKè¨­å®šå¾Œã€æ®‹ã‚Šã®Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: pip install -r zmk/requirements.txt || true

    - name: Build ZMK Firmware
      # west build ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚SDKãŒè¨­å®šã•ã‚ŒãŸãŸã‚ã€ãƒ“ãƒ«ãƒ‰ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
      run: |
        west build -s zmk/app -d build \
          -b seeeduino_xiao_ble \
          -- -DSHIELD=prospector_scanner \
          -DZMK_CONFIG=$GITHUB_WORKSPACE

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: build/zephyr/zmk.uf2
