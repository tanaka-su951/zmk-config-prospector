name: Build Prospector Firmware (Board Test Only)

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      # ZMK ツールチェーンがプリインストールされた安定の Docker Hub イメージ
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root

    steps:
      # ... (ステップ 1〜2 は変更なし: チェックアウトとクリーンアップ) ...

      # 3. west 初期化、アップデート、環境変数設定
      - name: Initialize West and Update Modules
        run: |
          CONFIG_DIR="config"
          # ... (west.yml の作成と west update は変更なし) ...
          echo "ZMK_CONFIG=$PWD/$CONFIG_DIR" >> $GITHUB_ENV
        shell: bash

      # 4. ビルド実行とすべてのパスの強制注入
      - name: Perform ZMK Build (BOARD ONLY Test)
        run: |
          export ZMK_CONFIG="$ZMK_CONFIG" 
          source zephyr/zephyr-env.sh
          
          # パス計算
          ZEPHYR_CMAKE_DIR="$PWD/zephyr/share/zephyr-package/cmake"
          ZEPHYR_ROOT_DIR="$PWD/zephyr"
          TOOLCHAIN_VARIANT="gnuarmemb"
          TOOLCHAIN_PATH="/opt/toolchains/gnuarmemb"
          
          echo "=== Starting ZMK Build (Testing Base Board) ==="
          
          # ★★★ 修正: -DSHIELD と -DSHIELD_DIR を削除 ★★★
          west build -s zmk/app -b seeeduino_xiao_ble -d build/board_only_test -- \
            -DZephyr_DIR="$ZEPHYR_CMAKE_DIR" \
            -DZEPHYR_BASE="$ZEPHYR_ROOT_DIR" \
            -DZEPHYR_TOOLCHAIN_VARIANT="$TOOLCHAIN_VARIANT" \
            -DGNUARMEMB_TOOLCHAIN_PATH="$TOOLCHAIN_PATH"
          
          echo "=== Test Complete ==="
          
          # ビルドが成功したかどうかの確認
          if [ -f "build/board_only_test/zephyr/zephyr.elf" ]; then
            echo "SUCCESS: Base board build passed! The issue is in the custom shield files."
          else
            echo "FATAL: Base board build failed. The issue is in the ZMK code base or the environment."
            exit 1
          fi
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        # シールドがなくてもボードのファームウェアをアップロード
        uses: actions/upload-artifact@v4
        with:
          name: seeeduino_xiao_ble-base-firmware
          path: build/board_only_test/zephyr/zephyr.uf2
