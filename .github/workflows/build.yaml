name: Build Prospector Firmware (Local)

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root

    steps:
      - name: Install Python Venv (Separate for apt)
        run: |
          apt update
          apt install -y python3.12-venv || apt install -y python3-venv
        shell: bash

      - name: Checkout ZMK Repository
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: main 
          path: zmk

      - name: Checkout Custom Config (prospector)
        uses: actions/checkout@v4
        with:
          path: prospector_config # カスタム設定リポジトリ

      - name: Initialize and Build ZMK Firmware (Integrated)
        run: |
          SHIELD_NAME="prospector_scanner"
          CONFIG_SRC="prospector_config"
          
          echo "=== 1. Initialize west workspace ==="
          # ZMK の公式 west.yml を使用して west init を実行
          west init -l zmk
          west update
          
          echo "=== 2. Export Zephyr/ZMK Environment Variables ==="
          west zephyr-export
          
          # ZEPHYR_MODULES とツールチェーンパスを明示的にエクスポート
          export ZEPHYR_MODULES="$PWD/zmk"
          export ZEPHYR_TOOLCHAIN_VARIANT=gnuarmemb
          export GNUARMEMB_TOOLCHAIN_PATH="/opt/toolchains/gnuarmemb"
          
          # zephyr-env.sh を source 
          ZEPHYR_ENV_SCRIPT="$PWD/zephyr/zephyr-env.sh"
          if [ -f "$ZEPHYR_ENV_SCRIPT" ]; then
              source "$ZEPHYR_ENV_SCRIPT"
          fi

          # Python venv のセットアップ
          /usr/bin/python3 -m venv zmk-env
          source zmk-env/bin/activate
          
          REQUIREMENTS_FILE=$(find zmk -name "requirements.txt" -print -quit)
          if [ -n "$REQUIREMENTS_FILE" ]; then
            pip install -r "$REQUIREMENTS_FILE"
          fi
          pip install pyyaml pykwalify
          
          echo "=== 3. Prepare Configuration Files (Copy into ZMK) ==="
          rm -rf build/prospector_scanner
          
          # 設定ファイルが ZMK の app/boards/shields の下にコピーされるように構造を作成
          SHIELD_DEST="zmk/app/boards/shields/$SHIELD_NAME"
          mkdir -p $SHIELD_DEST
          
          # シールド設定ファイルを ZMK の app/boards/shields の下にコピー
          cp $CONFIG_SRC/boards/shields/$SHIELD_NAME/$SHIELD_NAME.conf $SHIELD_DEST/$SHIELD_NAME.conf
          cp $CONFIG_SRC/boards/shields/$SHIELD_NAME/Kconfig $SHIELD_DEST/Kconfig
          
          # prj.conf を ZMK の app のルートにコピー
          cp $CONFIG_SRC/prj.conf zmk/app/prj.conf 

          echo "=== 4. Start ZMK Build (Official Structure) ==="
          
          # ZMK_CONFIG も EXTRA_CONF_FILE も不要、ZMK の app ディレクトリと DSHIELD のみ
          west build -s zmk/app -b seeeduino_xiao_ble -d build/prospector_scanner -- \
            -DSHIELD=$SHIELD_NAME
          
          echo "=== 5. Convert and Finalize ==="

          BIN_PATH="build/prospector_scanner/zephyr/zephyr.elf"
          UF2_PATH="build/prospector_scanner/zmk.uf2"

          if [ -f "$BIN_PATH" ]; then
            echo "Converting ELF → UF2"
            python3 zmk/tools/uf2conv.py "$BIN_PATH" -c -o "$UF2_PATH"
          else
            echo "FATAL: Build failed, zephyr.elf not found."
            ls -R build/prospector_scanner
            exit 1
          fi
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-seeeduino_xiao_ble-zmk
          path: build/prospector_scanner/zmk.uf2
