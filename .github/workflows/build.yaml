name: Build ZMK Firmware

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git wget xz-utils file cmake ninja-build gperf ccache \
            dfu-util device-tree-compiler python3-dev python3-pip \
            python3-setuptools python3-wheel jq

      - name: Download and install Zephyr SDK
        run: |
          echo "Fetching latest Zephyr SDK release tag..."
          ZEPHYR_SDK_TAG=$(curl -s https://api.github.com/repos/zephyrproject-rtos/sdk-ng/releases/latest | jq -r '.tag_name')
          echo "Latest Zephyr SDK tag: $ZEPHYR_SDK_TAG"

          # Linux x86_64 用の .run ファイルを探す
          SDK_URL=$(curl -s https://api.github.com/repos/zephyrproject-rtos/sdk-ng/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux-x86_64-setup.run$")) | .browser_download_url')

          echo "Downloading SDK from $SDK_URL"
          wget "$SDK_URL" -O zephyr-sdk.run
          chmod +x zephyr-sdk.run

          # インストール先を zephyr-sdk に指定
          ./zephyr-sdk.run --quiet -- -d $GITHUB_WORKSPACE/zephyr-sdk

          echo "SDK installed to $GITHUB_WORKSPACE/zephyr-sdk"
          echo "ZEPHYR_SDK_INSTALL_DIR=$GITHUB_WORKSPACE/zephyr-sdk" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/zephyr-sdk" >> $GITHUB_PATH

      - name: Install West
        run: pip3 install --user west

      - name: Initialize West
        run: |
          west init -l app
          west update
          west zephyr-export

      - name: Build firmware (seeeduino_xiao_ble + prospector_scanner)
        run: |
          west build -s app -b seeeduino_xiao_ble -- -DSHIELD=prospector_scanner

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v3
        with:
          name: firmware
          path: build/zephyr/*.uf2
