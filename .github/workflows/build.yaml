name: Build Prospector Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
    env:
      ZMK_VERSION: main
      BOARD: seeeduino_xiao_ble

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: zmk-config-prospector
          submodules: 'recursive'
          
      - name: Mount ZMK Firmware
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: ${{ env.ZMK_VERSION }}
          # ğŸš¨ ä¿®æ­£: ZMKã®ãƒ‘ã‚¹ã‚’ zmk-config-prospector/zmk ã«æˆ»ã™
          path: zmk-config-prospector/zmk
          submodules: 'recursive'
          
      - name: Install pip
        shell: bash
        run: |
          apt-get update
          apt-get install -y python3-pip
          
      - name: Install ZMK Dependencies
        shell: bash
        run: |
          # ğŸš¨ ä¿®æ­£: cd ã‚’å¾©æ´»ã•ã›ã€ç›¸å¯¾ãƒ‘ã‚¹ zmk/requirements.txt ã‚’ä½¿ç”¨
          cd zmk-config-prospector
          python3 -m pip install -r zmk/requirements.txt --break-system-packages
          
      - name: Create Custom Module Symlink
        shell: bash
        run: |
          # ğŸš¨ ä¿®æ­£: cd ã‚’å¾©æ´»
          cd zmk-config-prospector/zmk/app/modules
          ln -s ../../../modules/prospector-zmk-module prospector-zmk-module
        
      - name: Export Environment Variables
        shell: bash
        run: |
          # ğŸš¨ ä¿®æ­£: cd ã‚’å¾©æ´»
          cd zmk-config-prospector
          echo "DTC_INCLUDE_DIRS=${{ github.workspace }}/modules/prospector-zmk-module" >> $GITHUB_ENV
          echo "CONFIG_DIR=${{ github.workspace }}/config" >> $GITHUB_ENV
          
      - name: Run West Build (prospector_scanner)
        id: west_build_scanner
        shell: bash
        run: |
          # ğŸš¨ ä¿®æ­£: cd ã‚’å¾©æ´»
          cd zmk-config-prospector
          
          DTC_INCLUDE_PATH="${{ github.workspace }}/zmk-config-prospector/modules/prospector-zmk-module/dts" 
          
          # overlayãƒ•ã‚¡ã‚¤ãƒ«ã¯çµ¶å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨
          OVERLAY_FILES="${{ github.workspace }}/zmk-config-prospector/config/boards/${{ env.BOARD }}.overlay ${{ github.workspace }}/zmk-config-prospector/config/prospector_scanner.overlay"

          # -s ã¯ ZMK ã® app ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ç›¸å¯¾ãƒ‘ã‚¹
          west build -s zmk/app -d build/scanner -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_scanner" \
            -DDTC_OVERLAY_FILE="${OVERLAY_FILES}" \
            -DDTC_INCLUDE_DIRS="${DTC_INCLUDE_PATH}"

      - name: Run West Build (prospector_adapter)
        id: west_build_adapter
        shell: bash
        run: |
          # ğŸš¨ ä¿®æ­£: cd ã‚’å¾©æ´»
          cd zmk-config-prospector
          
          DTC_INCLUDE_PATH="${{ github.workspace }}/zmk-config-prospector/modules/prospector-zmk-module/dts" 

          OVERLAY_FILES="${{ github.workspace }}/zmk-config-prospector/config/boards/${{ env.BOARD }}.overlay ${{ github.workspace }}/zmk-config-prospector/config/prospector_adapter.overlay"

          west build -s zmk/app -d build/adapter -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_adapter" \
            -DDTC_OVERLAY_FILE="${OVERLAY_FILES}" \
            -DDTC_INCLUDE_DIRS="${DTC_INCLUDE_PATH}"

      - name: Archive Scanner Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-firmware
          # ğŸš¨ ä¿®æ­£: cd ã—ãŸå¾Œã®ç›¸å¯¾ãƒ‘ã‚¹
          path: zmk-config-prospector/build/scanner/zephyr/zmk_prospector_scanner.uf2

      - name: Archive Adapter Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_adapter-firmware
          # ğŸš¨ ä¿®æ­£: cd ã—ãŸå¾Œã®ç›¸å¯¾ãƒ‘ã‚¹
          path: zmk-config-prospector/build/adapter/zephyr/zmk_prospector_adapter.uf2

