name: Build Prospector Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. ワークスペースの依存関係をチェックアウト
      - name: Checkout Custom Config
        uses: actions/checkout@v4
        with:
          path: config

      # 2. ZMK環境をセットアップ（正しいアクション名を使用）
      - name: Set up ZMK environment and Install Dependencies
        uses: zmkfirmware/setup-action@v2 
      
      # 3. ZMKリポジトリをチェックアウト（west updateの準備）
      - name: Checkout ZMK Repository
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: main 
          path: zmk

      # 4. west初期化と依存関係の更新
      - name: Initialize West and Update Modules
        run: |
          CONFIG_DIR="config"

          # west.yml を作成
          cat << EOF > $CONFIG_DIR/west.yml
          manifest:
            remotes:
              - name: zmkfirmware
                url-base: https://github.com/zmkfirmware
            projects:
              - name: zmk
                remote: zmkfirmware
                revision: main
                import: app/west.yml
            self:
              path: config
          EOF

          # west initとupdateを実行
          west init -l $CONFIG_DIR
          west update
          
          # ZMK_CONFIG のエクスポート (シールド認識に必要)
          echo "ZMK_CONFIG=$PWD/$CONFIG_DIR" >> $GITHUB_ENV
          
        shell: bash

      # 5. ビルド実行とZephyrパスの強制注入
      - name: Perform ZMK Build (Path Injection)
        run: |
          # ZMK_CONFIG をシェルにエクスポート
          export ZMK_CONFIG="$ZMK_CONFIG" 
          
          # Zephyr環境をsource
          source zephyr/zephyr-env.sh
          
          # Zephyrのパスを計算
          ZEPHYR_CMAKE_DIR="$PWD/zephyr/share/zephyr-package/cmake"
          ZEPHYR_ROOT_DIR="$PWD/zephyr"
          
          echo "=== Starting ZMK Build ==="
          
          # 過去の find_package エラーを回避するため、Zephyrパスを引数として強制注入
          west build -s zmk/app -b seeeduino_xiao_ble -d build/prospector_scanner -- \
            -DSHIELD=prospector_scanner \
            -DZephyr_DIR="$ZEPHYR_CMAKE_DIR" \
            -DZEPHYR_BASE="$ZEPHYR_ROOT_DIR"
          
          echo "=== Convert and Finalize ==="

          BIN_PATH="build/prospector_scanner/zephyr/zephyr.elf"
          UF2_PATH="build/prospector_scanner/zmk.uf2"

          if [ -f "$BIN_PATH" ]; then
            echo "Converting ELF → UF2"
            python3 zmk/tools/uf2conv.py "$BIN_PATH" -c -o "$UF2_PATH"
          else
            echo "FATAL: Build failed, zephyr.elf not found."
            exit 1
          fi
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-seeeduino_xiao_ble-zmk
          path: build/prospector_scanner/zmk.uf2
