# ZMK Custom Config Build Workflow (ZMKå…¬å¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’å®Œå…¨ã«å†ç¾)
# ğŸš¨ ã“ã‚ŒãŒã€Kconfigãƒ•ãƒªãƒ¼ã‚ºã¨ç’°å¢ƒå•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã®æœ€å¾Œã®è«–ç†çš„ãªæ§‹æˆã§ã™ ğŸš¨

name: Build ZMK Firmware (Official Full Clone)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      board:
        description: 'Target Board (e.g., seeeduino_xiao_ble)'
        required: true
        default: 'seeeduino_xiao_ble'
      shield:
        description: 'Target Shield (e.g., prospector_scanner)'
        required: true
        default: 'prospector_scanner'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      # ZMKå…¬å¼ãŒæ¨å¥¨ã™ã‚‹ã€ä¾å­˜é–¢ä¿‚ãŒã™ã¹ã¦è¨­å®šæ¸ˆã¿ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
      image: ghcr.io/zmkfirmware/zmk-build-arm:stable
      # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã™ã‚‹å ´åˆã€èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã«credential-ghcã‚’ç„¡åŠ¹åŒ–
      options: --user root

    steps:
    - name: Checkout ZMK Config
      uses: actions/checkout@v4
      with:
        submodules: true  # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        fetch-depth: 0

    # 1. ZMKã‚³ã‚¢ãƒªãƒã‚¸ãƒˆãƒªã®å–å¾—ã¨weståˆæœŸåŒ–
    - name: Initialize West Workspace
      # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ZMKã®ãƒ‘ã‚¹ãŒ /opt/zmk ã§ã‚ã‚‹ã¨æƒ³å®šã•ã‚Œã¾ã™
      run: |
        echo "--- 1. weståˆæœŸåŒ–ã¨ä¾å­˜é–¢ä¿‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---"
        # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«zmkãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
        cp /opt/zmk/west.yml west.yml
        # west initã¯å¼•æ•°ãªã—ã§å®Ÿè¡Œã—ã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®west.ymlã‚’ä½¿ç”¨
        west init
        west update
        
    # 2. Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install Python Dependencies
      run: |
        echo "--- 2. Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
        pip3 install -r /opt/zmk/requirements.txt
        
    # 3. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
    - name: Run West Build
      run: |
        echo "--- 3. west buildå®Ÿè¡Œï¼ˆKconfigå›é¿ç­–ä¸è¦ï¼‰ ---"
        # ZMKã®æ¨å¥¨ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€ZMK_CONFIGã‚’ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«è¨­å®š
        # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€Kconfigãƒ•ãƒªãƒ¼ã‚ºã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“
        /opt/zmk/zephyr/scripts/zephyr-export.sh
        
        west build -s /opt/zmk/app -d build --sysbuild \
          -b ${{ github.event.inputs.board }} \
          -- -DSHIELD=${{ github.event.inputs.shield }} \
          -DZMK_CONFIG=${{ github.workspace }}
        
    # 4. æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.board }}-${{ github.event.inputs.shield }}
        path: build/zephyr/zmk.uf2
