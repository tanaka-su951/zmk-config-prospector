name: Build Prospector Scanner Firmware

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # 依存関係のインストール
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake ninja-build gperf ccache dfu-util wget \
            device-tree-compiler python3-pip python3-setuptools python3-wheel python3-venv

      # Python 仮想環境を作成
      - name: Set up Python virtual environment
        run: |
          python3 -m venv zmk-env
          source zmk-env/bin/activate
          pip install --upgrade pip
          pip install west

      # ZMK の west ワークスペースを初期化
      - name: Initialize west workspace
        run: |
          rm -rf .west
          west init -m https://github.com/zmkfirmware/zmk .
          west update
          west zephyr-export

      # ZMK ツールチェーンのインストール
      - name: Install Zephyr SDK
        run: |
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.5/zephyr-sdk-0.16.5_linux-x86_64.tar.xz
          tar xf zephyr-sdk-0.16.5_linux-x86_64.tar.xz
          sudo mv zephyr-sdk-0.16.5 /opt/zephyr-sdk
          /opt/zephyr-sdk/setup.sh -t arm-zephyr-eabi

      # 設定ファイルを自動生成
      - name: Prepare Configuration
        run: |
          source zmk-env/bin/activate
          CONFIG_DIR="config"
          SHIELD_DIR="$CONFIG_DIR/boards/shields/prospector_scanner"
          mkdir -p "$SHIELD_DIR"

          # prj.conf
          if [ ! -f "$CONFIG_DIR/prj.conf" ]; then
            echo "Creating $CONFIG_DIR/prj.conf"
cat <<'EOF' > "$CONFIG_DIR/prj.conf"
CONFIG_ZMK_KEYBOARD_NAME="Prospector Scanner"
CONFIG_ZMK_KSCAN_MATRIX=y
CONFIG_ZMK_DISPLAY=y
EOF
          fi

          # shield config
          if [ ! -f "$SHIELD_DIR/prospector_scanner.conf" ]; then
            echo "Creating shield config"
cat <<'EOF' > "$SHIELD_DIR/prospector_scanner.conf"
CONFIG_ZMK_KEYBOARD_NAME="Prospector Scanner"
EOF
          fi

          # Kconfig
cat <<'EOF' > "$SHIELD_DIR/Kconfig"
config SHIELD_PROSPECTOR_SCANNER
    bool "Prospector Scanner"
    default y
EOF

          # CMakeLists.txt
cat <<'EOF' > "$CONFIG_DIR/CMakeLists.txt"
cmake_minimum_required(VERSION 3.20.0)
find_package(Zephyr REQUIRED HINTS $ENV{ZEPHYR_BASE})
project(zmk-config-prospector)
target_sources(app PRIVATE src/main.c)
EOF

      # ビルドを実行
      - name: Build firmware
        run: |
          source zmk-env/bin/activate
          west build -s zmk/app -b seeeduino_xiao_ble -- -DSHIELD=prospector_scanner -DZMK_CONFIG=config

      # 成果物のアップロード
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner_firmware
          path: build/zephyr/zmk.uf2

