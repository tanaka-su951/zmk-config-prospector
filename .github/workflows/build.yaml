name: Build ZMK Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. リポジトリチェックアウト
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    # 2. 依存関係インストール
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git python3-pip ninja-build cmake wget

    # 3. West インストール
    - name: Install west
      run: python3 -m pip install --upgrade west

    # 4. West ワークスペース初期化
    - name: Initialize west workspace
      run: |
        west init -l config
        west update

    # 5. Zephyr SDK のインストール
    - name: Install Zephyr SDK
      run: |
        wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.0/zephyr-sdk-0.16.0-x86_64-linux-ubuntu22.tar.gz
        tar xf zephyr-sdk-0.16.0-x86_64-linux-ubuntu22.tar.gz
        ./zephyr-sdk-0.16.0-x86_64-linux-ubuntu22/./setup.sh -h
      env:
        ZEPHYR_TOOLCHAIN_VARIANT: zephyr
        ZEPHYR_SDK_INSTALL_DIR: ${{ github.workspace }}/zephyr-sdk

    # 6. ファームウェアビルド
    - name: Build firmware
      run: west build -s app -b seeeduino_xiao_ble -- -DSHIELD=prospector_scanner

    # 7. uf2conv.py をダウンロード（Adafruit UF2 converter）
    - name: Download uf2conv.py
      run: wget -O uf2conv.py https://raw.githubusercontent.com/adafruit/uf2utils/main/uf2conv.py

    # 8. HEX → UF2 変換
    - name: Convert HEX to UF2
      run: |
        python3 uf2conv.py build/zephyr/zephyr.hex \
          --base 0x26000 \
          --family 0xADA52840 \
          --outpu
