name: ZMK Custom Config Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ZMK Config (No Submodules)
        uses: actions/checkout@v4
        with:
          # Gitã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾å­˜ã—ãªã„
          fetch-depth: 0
          submodules: false 

      # 1. ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install ZMK Build Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip git wget ccache
          pip install west
          
          # Zephyr SDK (v0.17.4) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.4/zephyr-sdk-0.17.4_linux-x86_64.tar.xz
          tar xvf zephyr-sdk-0.17.4_linux-x86_64.tar.xz
          # ARMãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          ./zephyr-sdk-0.17.4/setup.sh -t arm-zephyr-eabi
          
      # 2. westãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®åˆæœŸåŒ–ã¨æ›´æ–° (å…¨ä¾å­˜é–¢ä¿‚ã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å«ã‚€)
      - name: Initialize and Update ZMK Workspace (Core & Modules Clone)
        run: |
          # --- ğŸš¨ æœ€çµ‚ä¿®æ­£: å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ  ğŸš¨ ---
          # éå»ã®å¤±æ•—ã§æ®‹ã•ã‚ŒãŸwestè¨­å®šã¨ZMKãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã€ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§west initã‚’å¼·åˆ¶ã™ã‚‹
          echo "--- DEBUG: Cleaning up old west artifacts ---"
          if [ -d ".west" ]; then rm -rf .west; fi
          if [ -d "zmk" ]; then rm -rf zmk; fi
          echo "Cleanup complete."
          # -----------------------------------------------

          # west.yml ã‚’èª­ã¿è¾¼ã¿ã€ZMKã‚³ã‚¢ã€Zephyrã€ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã™ã¹ã¦ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹
          west init -l . 
          west update
          
          # ã‚¯ãƒ­ãƒ¼ãƒ³ãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒã‚§ãƒƒã‚¯
          if [ ! -d "zmk/app" ]; then
            echo "FATAL: west update failed to clone ZMK core. Check west.yml remotes/revisions."
            exit 1 
          fi
          
          # ã€ãƒ‡ãƒãƒƒã‚°ã€‘Zephyrã‚³ã‚¢ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
          echo "--- DEBUG: Listing Zephyr and Modules ---"
          ls -l zephyr/ || echo "Zephyr directory missing or empty."
          ls -l modules/ || echo "Modules directory missing or empty."
          echo "------------------------------------------"
          
          # ZMKã®Pythonè¦ä»¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install -r zmk/requirements.txt || true 
          
      # 3. Zephyrç’°å¢ƒå¤‰æ•°ã®è¨­å®š
      - name: Source Zephyr Environment
        run: |
          echo "ZEPHYR_TOOLCHAIN_VARIANT=zephyr" >> $GITHUB_ENV
          echo "ZEPHYR_SDK_INSTALL_DIR=/home/runner/zephyr-sdk-0.17.4" >> $GITHUB_ENV
          
      # 4. ZMK ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ãƒ“ãƒ«ãƒ‰
      - name: Build ZMK Firmware
        run: |
          echo "--- DEBUG: Starting Build ---"
          # west build ã‚³ãƒãƒ³ãƒ‰ã‚’ä¸€è¡Œã«ã¾ã¨ã‚ã¦è¨˜è¿°
          west build -s zmk/app -d build -b seeeduino_xiao_ble -- -DSHIELD=prospector_scanner -DZMK_CONFIG=$GITHUB_WORKSPACE
            
      # 5. ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: seeeduino_xiao_ble-prospector_scanner
          path: build/zephyr/zmk.uf2
          if-no-files-found: error
          retention-days: 7
