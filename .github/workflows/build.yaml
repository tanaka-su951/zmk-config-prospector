# ZMKãƒ“ãƒ«ãƒ‰ã®æœ€çµ‚å®‰å®šç‰ˆã€‚ãƒ›ã‚¹ãƒˆOSã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’å®Œäº†ã•ã›ã¦ã‹ã‚‰Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

name: Build ZMK Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
    defaults:
      run:
        working-directory: ${{ github.workspace }}
        
    # ãƒ›ã‚¹ãƒˆOSã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’å‡¦ç†
    runs-on: ubuntu-latest
    
    # Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
    container: zmkfirmware/zmk-build-arm:stable
    
    strategy:
      matrix:
        board: [seeeduino_xiao_ble]
        shield: [prospector_scanner]
        
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¨ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          path: config # ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ 'config' ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

      # 2. westãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ˜ç¤ºçš„ã«åˆæœŸåŒ–ã—ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°
      # ğŸ’¥ æœ€çµ‚ä¿®æ­£: west init/update ã‚’ ZMK ã®æ¨™æº–ã‚³ãƒãƒ³ãƒ‰ã«ç½®ãæ›ãˆ
      - name: Initialize and Update ZMK modules
        working-directory: config
        run: |
          # west init ã‚’æœ€åˆã«å®Ÿè¡Œã—ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
          west init -l .
          west update --rebase
        
      # 3. ZMKãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ãƒ“ãƒ«ãƒ‰
      # ğŸ’¥ æœ€çµ‚ä¿®æ­£: ãƒ“ãƒ«ãƒ‰ã¯ ZMK/app ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚½ãƒ¼ã‚¹ã¨ã—ã¦å®Ÿè¡Œ
      - name: Build ZMK firmware
        working-directory: config/zmk/app
        run: west build -p -b ${{ matrix.board }} -- -DSHIELD=${{ matrix.shield }}

      # 4. ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      - name: Archive firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-seeeduino_xiao_ble
          # ãƒ“ãƒ«ãƒ‰çµæœãŒ config/zmk/app/build/zephyr/zephyr.uf2 ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ãƒ‘ã‚¹ã‚’å¤‰æ›´
          path: config/zmk/app/build/zephyr/zephyr.uf2
