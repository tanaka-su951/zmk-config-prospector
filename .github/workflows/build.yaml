# ZMKãƒ“ãƒ«ãƒ‰ã®æœ€çµ‚å®‰å®šç‰ˆã€‚ãƒ›ã‚¹ãƒˆOSã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’å®Œäº†ã•ã›ã¦ã‹ã‚‰Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

name: Build ZMK Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
    defaults:
      run:
        working-directory: ${{ github.workspace }}
        
    # ãƒ›ã‚¹ãƒˆOSã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’å‡¦ç†
    runs-on: ubuntu-latest
    
    # Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨
    container: zmkfirmware/zmk-build-arm:stable
    
    strategy:
      matrix:
        board: [seeeduino_xiao_ble]
        shield: [prospector_scanner]
        
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¨ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          path: config # ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ 'config' ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

      # 2. ğŸ’¥ çµ±åˆ: westç’°å¢ƒã®åˆæœŸåŒ–ã¨ãƒ“ãƒ«ãƒ‰ã‚’ã¾ã¨ã‚ã¦å®Ÿè¡Œ
      - name: Initialize, Update and Build ZMK firmware
        working-directory: config
        run: |
          # west.yml ã‚’ãƒ«ãƒ¼ãƒˆã«æˆ»ã™ (ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’æ•´ãˆã‚‹)
          mv west.yml ..
          cd ..
          
          # éå»ã®ZMKã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã€ã‚¯ãƒªãƒ¼ãƒ³ãªç’°å¢ƒã‹ã‚‰é–‹å§‹
          rm -rf zmk
          
          # westç’°å¢ƒã‚’åˆæœŸåŒ–ã—ã€ZMKæœ¬ä½“ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          west init -l .
          west update --rebase
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒå®‰å®šã™ã‚‹ã®ã‚’å¾…ã¤ (é‡è¦)
          sleep 5

          # ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ: ZMK/appã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
          # west updateãŒæˆåŠŸã™ã‚Œã°ã€zmk/appã¯ãƒ«ãƒ¼ãƒˆã«å­˜åœ¨
          west build -s zmk/app -p -b ${{ matrix.board }} -- -DSHIELD=${{ matrix.shield }}
        
      # 3. ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– (ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚’ä¿®æ­£)
      - name: Archive firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-seeeduino_xiao_ble
          # ãƒ“ãƒ«ãƒ‰çµæœã®ãƒ‘ã‚¹ã‚’ build/zephyr/zephyr.uf2 ã«è¨­å®š
          path: build/zephyr/zephyr.uf2
