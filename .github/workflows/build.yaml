name: Build Prospector Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable 
    env:
      ZMK_VERSION: main
      BOARD: seeeduino_xiao_ble

    steps:
      # 1. あなたの設定ファイル（config、modules）をワークスペースのルートにチェックアウト
      - name: Checkout Config Files
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          submodules: 'recursive'
          
      # 2. ZMK コアコードを 'zmk' フォルダにチェックアウト
      - name: Mount ZMK Firmware
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: ${{ env.ZMK_VERSION }}
          path: zmk # ワークスペース直下の zmk/
          submodules: 'recursive'
          
      # 3. West ワークスペースの初期化と依存関係の取得
      - name: Initialize West Workspace
        shell: bash
        working-directory: zmk
        run: |
          west init -l app
          west update
          
      # 4. カスタムモジュールのシンボリックリンク作成
      - name: Create Custom Module Symlink
        shell: bash
        working-directory: zmk 
        run: |
          mkdir -p app/modules
          ln -s ../../modules/prospector-zmk-module app/modules/prospector-zmk-module
        
      # 4.5. モジュール Kconfig パスを West に追加 (新しいステップ)
      - name: Set Module Kconfig Path
        shell: bash
        working-directory: zmk
        run: |
          # ワークスペースのルートにあるカスタムモジュールの Kconfig ディレクトリを ZMK に設定
          echo "EXTRA_KCONFIG_DIRS=${{ github.workspace }}/modules/prospector-zmk-module/config" >> $GITHUB_ENV
          
      # 5. 環境変数のエクスポート (DTC_INCLUDE_DIRSはwest buildに直接渡すため、これは古い設定)
      - name: Export Environment Variables
        shell: bash
        run: |
          echo "DTC_INCLUDE_DIRS=${{ github.workspace }}/modules/prospector-zmk-module/dts" >> $GITHUB_ENV
          echo "CONFIG_DIR=${{ github.workspace }}/config" >> $GITHUB_ENV # これはKconfigの自動検索に使われる可能性があるため維持
          
      # 6. ビルドの実行
      - name: Run West Build (prospector_scanner)
        id: west_build_scanner
        shell: bash
        working-directory: zmk
        run: |
          # DTC_OVERLAY_FILEとDTC_INCLUDE_DIRSはセミコロン区切りで渡す
          west build -s app -d ../build/scanner -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_scanner" \
            -DDTC_OVERLAY_FILE="${{ github.workspace }}/config/boards/${{ env.BOARD }}.overlay;${{ github.workspace }}/config/prospector_scanner.overlay" \
            -DDTC_INCLUDE_DIRS="${{ github.workspace }}/modules/prospector-zmk-module/dts"

      - name: Run West Build (prospector_adapter)
        id: west_build_adapter
        shell: bash
        working-directory: zmk
        run: |
          west build -s app -d ../build/adapter -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_adapter" \
            -DDTC_OVERLAY_FILE="${{ github.workspace }}/config/boards/${{ env.BOARD }}.overlay;${{ github.workspace }}/config/prospector_adapter.overlay" \
            -DDTC_INCLUDE_DIRS="${{ github.workspace }}/modules/prospector-zmk-module/dts"

      - name: Archive Scanner Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-firmware
          path: build/scanner/zephyr/zmk_prospector_scanner.uf2

      - name: Archive Adapter Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_adapter-firmware
          path: build/adapter/zephyr/zmk_prospector_adapter.uf2
