name: Build Prospector Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable 
    env:
      ZMK_VERSION: main
      BOARD: seeeduino_xiao_ble

    steps:
      # 1. „ÅÇ„Å™„Åü„ÅÆË®≠ÂÆö„Éï„Ç°„Ç§„É´Ôºàconfig„ÄÅmodulesÔºâ„Çí„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅÆ„É´„Éº„Éà„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout Config Files
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          submodules: 'true' 
          fetch-depth: 0 
          
      # 2. ZMK „Ç≥„Ç¢„Ç≥„Éº„Éâ„Çí 'zmk' „Éï„Ç©„É´„ÉÄ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Mount ZMK Firmware
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: ${{ env.ZMK_VERSION }}
          path: zmk
          submodules: 'recursive'
          
      # 3. West „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅÆÂàùÊúüÂåñ„Å®‰æùÂ≠òÈñ¢‰øÇ„ÅÆÂèñÂæó
      - name: Initialize West Workspace
        shell: bash
        working-directory: zmk
        run: |
          west init -l app
          west update

      # 3.5. üö® Git„Çµ„Éñ„É¢„Ç∏„É•„Éº„É´„ÇíÂº∑Âà∂ÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Force Custom Module Checkout
        shell: bash
        run: |
          # üö® ‰øÆÊ≠£: Git„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö„ÅØ‰∏çË¶Å„ÄÅ„É¢„Ç∏„É•„Éº„É´Êõ¥Êñ∞„ÅÆ„Åø
          git submodule update --init --recursive
          
          # „Éï„Ç©„É´„ÉÄ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„Å´ÂÇô„Åà„Å¶„ÄÅÂº∑Âà∂ÁöÑ„Å´„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰ΩúÊàêÔºàcp „ÅÆ„Ç®„É©„ÉºÂõûÈÅø„ÅÆ„Åü„ÇÅÔºâ
          mkdir -p $GITHUB_WORKSPACE/modules/prospector-zmk-module
          
          echo "Final check for custom module folder:"
          ls -ld $GITHUB_WORKSPACE/modules/prospector-zmk-module
          
      # 4. „Ç´„Çπ„Çø„É†„É¢„Ç∏„É•„Éº„É´„ÇíZMK„Ç≥„Ç¢„ÅÆ 'modules' „Éï„Ç©„É´„ÉÄ„Å´Áõ¥Êé•„Ç≥„Éî„Éº
      - name: Copy Custom Module to ZMK Core Modules
        shell: bash
        working-directory: zmk/modules
        run: |
          # „Ç≥„Éî„ÉºÂÖÉ: „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„É´„Éº„Éà/modules/prospector-zmk-module (Áµ∂ÂØæ„Éë„Çπ)
          # „Ç≥„Éî„ÉºÂÖà: zmk/modules/
          # üö® ‰øÆÊ≠£: Â≠òÂú®„Åó„Å™„ÅÑ„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº„Åó„Çà„ÅÜ„Å®„Åó„Å¶Â§±Êïó„Åô„ÇãÂèØËÉΩÊÄß„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÄÅ‰∏ÄÊó¶ ls „ÅÆÁµêÊûú„ÇíÁÑ°Ë¶ñ
          cp -r $GITHUB_WORKSPACE/modules/prospector-zmk-module . || true
          
      # 5. Áí∞Â¢ÉÂ§âÊï∞„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
      - name: Export Environment Variables
        shell: bash
        run: |
          echo "CONFIG_DIR=$GITHUB_WORKSPACE/config" >> $GITHUB_ENV 
          
      # 6. „Éì„É´„Éâ„ÅÆÂÆüË°å
      - name: Run West Build (prospector_scanner)
        id: west_build_scanner
        shell: bash
        working-directory: zmk
        run: |
          west build -s app -d ../build/scanner -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_scanner" \
            -DCONFIG_DIR="$GITHUB_WORKSPACE/config" \
            -DDTC_OVERLAY_FILE="$GITHUB_WORKSPACE/config/boards/${{ env.BOARD }}.overlay;$GITHUB_WORKSPACE/config/prospector_scanner.overlay"

      - name: Run West Build (prospector_adapter)
        id: west_build_adapter
        shell: bash
        working-directory: zmk
        run: |
          west build -s app -d ../build/adapter -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_adapter" \
            -DCONFIG_DIR="$GITHUB_WORKSPACE/config" \
            -DDTC_OVERLAY_FILE="$GITHUB_WORKSPACE/config/boards/${{ env.BOARD }}.overlay;$GITHUB_WORKSPACE/config/prospector_adapter.overlay"

      - name: Archive Scanner Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-firmware
          path: build/scanner/zephyr/zmk_prospector_scanner.uf2

      - name: Archive Adapter Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_adapter-firmware
          path: build/adapter/zephyr/zmk_prospector_adapter.uf2
