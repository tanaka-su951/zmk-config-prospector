name: Build Prospector Firmware (Official ZMK Action)

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    # Docker コンテナを削除し、標準ランナーに戻す
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Custom Config
        uses: actions/checkout@v4
        with:
          # config ディレクトリが ZMK_CONFIG として自動的に認識されるように
          path: config

      # ★★★ 最終の変更: 公式のセットアップアクションを使用して環境を構築 ★★★
      - name: Set up ZMK environment
        uses: zmkfirmware/zmk-setup-action@v2 
        # ZMK リポジトリは自動でクローンされ、west init/update も実行されます。
        
      - name: Perform ZMK Build
        run: |
          CONFIG_DIR="config"
          
          echo "=== Starting ZMK Build ==="
          
          # ZMK_CONFIG はアクションによって設定されるため、ビルドコマンドはシンプルになります。
          # -s $ZMK_HOME/app は、セットアップアクションによって設定された環境パスを使用します。
          west build -s zmk/app -b seeeduino_xiao_ble -d build/prospector_scanner -- \
            -DSHIELD=prospector_scanner
          
          echo "=== Convert and Finalize ==="

          BIN_PATH="build/prospector_scanner/zephyr/zephyr.elf"
          UF2_PATH="build/prospector_scanner/zmk.uf2"

          if [ -f "$BIN_PATH" ]; then
            echo "Converting ELF → UF2"
            # ZMK のツールを使用して変換
            python3 zmk/tools/uf2conv.py "$BIN_PATH" -c -o "$UF2_PATH"
          else
            echo "FATAL: Build failed, zephyr.elf not found."
            ls -R build/prospector_scanner
            exit 1
          fi
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-seeeduino_xiao_ble-zmk
          path: build/prospector_scanner/zmk.uf2
