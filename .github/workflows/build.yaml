name: Build Prospector Firmware (Final Working Version)

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      # ZMK ツールチェーンがプリインストールされた安定の Docker Hub イメージを使用
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root

    steps:
      # 1. ディスク容量のクリーンアップ (変更なし)
      - name: Free Disk Space (Custom)
        run: |
          rm -rf /usr/local/lib/android /usr/share/dotnet
          apt clean
          rm -rf /var/lib/apt/lists/*
        shell: bash

      # 2. カスタム設定をワークスペースのルートにチェックアウト
      - name: Checkout Custom Config
        uses: actions/checkout@v4
        with:
          # ★★★ 修正: path: config を削除。設定ファイルをルートに置く ★★★
          path: . 
          
      # 3. west 初期化とアップデート
      - name: Initialize West and Update Modules
        run: |
          CONFIG_DIR="." # config はルート (./) にある

          echo "=== 1. Setup west workspace and west.yml ==="
          
          # west.yml は config/west.yml ではなく、./west.yml に配置
          cat << EOF > west.yml
          manifest:
            remotes:
              - name: zmkfirmware
                url-base: https://github.com/zmkfirmware
            projects:
              - name: zmk
                remote: zmkfirmware
                revision: main
                import: app/west.yml
            self:
              path: . # ワークスペースのルートに配置
          EOF

          # west init をワークスペースのルートで実行
          west init -l . 
          west update
          
          # ZMK_CONFIG を環境変数として次ステップに渡す
          echo "ZMK_CONFIG=$PWD" >> $GITHUB_ENV
          
        shell: bash

      # 4. ビルド実行と環境の初期化
      - name: Perform ZMK Build (Source Check)
        run: |
          export ZMK_CONFIG="$ZMK_CONFIG" 
          
          # Zephyr 環境を source で初期化
          ZEPHYR_ENV_SCRIPT="$PWD/zephyr/zephyr-env.sh"
          
          # ★★★ 最終チェック: zephyr/ ディレクトリのリスト表示を追加 ★★★
          echo "Listing files in root directory:"
          ls -F $PWD
          echo "Listing files in zephyr directory:"
          ls -F $PWD/zephyr || true
          
          if [ -f "$ZEPHYR_ENV_SCRIPT" ]; then
              echo "SUCCESS: zephyr-env.sh found. Starting build..."
              source "$ZEPHYR_ENV_SCRIPT"
          else
              echo "FATAL: zephyr/zephyr-env.sh not found. This is the last possible cause."
              exit 1
          fi

          # west build をシンプルな形で実行
          west build -s zmk/app -b seeeduino_xiao_ble -d build/final_attempt
          
          # ... (後略: uf2 変換とアップロード)
        shell: bash

      - name: Archive production artifacts (Artifact Upload)
        uses: actions/upload-artifact@v4
        with:
          name: seeeduino_xiao_ble-final-firmware
          path: build/final_attempt/zephyr.uf2
