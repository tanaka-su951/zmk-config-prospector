name: Build Prospector Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable 
    env:
      ZMK_VERSION: main
      BOARD: seeeduino_xiao_ble

    steps:
      # 1. „ÅÇ„Å™„Åü„ÅÆË®≠ÂÆö„Éï„Ç°„Ç§„É´Ôºàconfig„ÄÅmodulesÔºâ„Çí„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅÆ„É´„Éº„Éà„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout Config Files
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          submodules: 'recursive'
          
      # 2. ZMK „Ç≥„Ç¢„Ç≥„Éº„Éâ„Çí 'zmk' „Éï„Ç©„É´„ÉÄ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Mount ZMK Firmware
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: ${{ env.ZMK_VERSION }}
          path: zmk # „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„ÇπÁõ¥‰∏ã„ÅÆ zmk/
          submodules: 'recursive'
          
      # ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´„Çπ„ÉÜ„ÉÉ„Éó„ÅØÂâäÈô§Ê∏à„Åø
          
      # 4. „Ç´„Çπ„Çø„É†„É¢„Ç∏„É•„Éº„É´„ÅÆ„Ç∑„É≥„Éú„É™„ÉÉ„ÇØ„É™„É≥„ÇØ‰ΩúÊàê (‰øÆÊ≠£Ê∏à„Åø)
      - name: Create Custom Module Symlink
        shell: bash
        # üö® ‰øÆÊ≠£: working-directory „ÇíÁ¢∫ÂÆü„Å´Â≠òÂú®„Åô„Çã zmk/app „Å´Â§âÊõ¥
        working-directory: zmk/app 
        run: |
          # üö® ‰øÆÊ≠£: „É™„É≥„ÇØ„ÅÆ‰ΩúÊàêÂ†¥ÊâÄ„Åå zmk/app „Å´„Å™„Å£„Åü„ÅÆ„Åß„ÄÅmodules/ „Çí‰ªò„Åë„Å¶ÂÆüË°å
          # „Ç∑„É≥„Éú„É™„ÉÉ„ÇØ„É™„É≥„ÇØ„ÅÆ„É™„É≥„ÇØÂÖà„ÅØ„É´„Éº„Éà„Åã„Çâ„ÅÆÁõ∏ÂØæ„Éë„Çπ (../../modules/...)
          ln -s ../../modules/prospector-zmk-module modules/prospector-zmk-module
        
      - name: Export Environment Variables
        shell: bash
        run: |
          echo "DTC_INCLUDE_DIRS=${{ github.workspace }}/modules/prospector-zmk-module/dts" >> $GITHUB_ENV
          echo "CONFIG_DIR=${{ github.workspace }}/config" >> $GITHUB_ENV
          
      # 5. „Éì„É´„Éâ„ÅÆÂÆüË°å
      - name: Run West Build (prospector_scanner)
        id: west_build_scanner
        shell: bash
        # working-directory „Çí ZMK „ÅÆ„É´„Éº„Éà„Å´Ë®≠ÂÆö
        working-directory: zmk
        run: |
          DTC_INCLUDE_PATH="${{ github.workspace }}/modules/prospector-zmk-module/dts" 
          OVERLAY_FILES="${{ github.workspace }}/config/boards/${{ env.BOARD }}.overlay ${{ github.workspace }}/config/prospector_scanner.overlay"

          # -s „ÅØ app/ „Çí‰ΩøÁî®„Åó„ÄÅ-d „ÅØ build/scanner „Çí‰ΩøÁî®
          west build -s app -d ../build/scanner -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_scanner" \
            -DDTC_OVERLAY_FILE="${OVERLAY_FILES}" \
            -DDTC_INCLUDE_DIRS="${DTC_INCLUDE_PATH}"

      - name: Run West Build (prospector_adapter)
        id: west_build_adapter
        shell: bash
        # working-directory „Çí ZMK „ÅÆ„É´„Éº„Éà„Å´Ë®≠ÂÆö
        working-directory: zmk
        run: |
          DTC_INCLUDE_PATH="${{ github.workspace }}/modules/prospector-zmk-module/dts" 
          OVERLAY_FILES="${{ github.workspace }}/config/boards/${{ env.BOARD }}.overlay ${{ github.workspace }}/config/prospector_adapter.overlay"

          west build -s app -d ../build/adapter -b ${{ env.BOARD }} -- \
            -DAPP_LABEL="prospector_adapter" \
            -DDTC_OVERLAY_FILE="${OVERLAY_FILES}" \
            -DDTC_INCLUDE_DIRS="${DTC_INCLUDE_PATH}"

      - name: Archive Scanner Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_scanner-firmware
          path: build/scanner/zephyr/zmk_prospector_scanner.uf2

      - name: Archive Adapter Firmware
        uses: actions/upload-artifact@v4
        with:
          name: prospector_adapter-firmware
          path: build/adapter/zephyr/zmk_prospector_adapter.uf2
