# ZMK Custom Config Build Workflow (SDKè‡ªå‹•æ¤œå‡ºã«ã‚ˆã‚‹æœ€çµ‚ä¿®æ­£)

name: Build ZMK Firmware (Final Attempt)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ZMK Config and Submodules
      uses: actions/checkout@v4
      with:
        # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®šã¯Git/Westã®å•é¡Œã®ãŸã‚ç„¡åŠ¹åŒ–
        submodules: false
        fetch-depth: 0

    - name: Setup Python Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv git
        python3 -m pip install -U west

    - name: --- ğŸš¨ ZMK ã‚³ã‚¢ã®æ‰‹å‹•ã‚¯ãƒ­ãƒ¼ãƒ³ã¨åˆæœŸåŒ– ğŸš¨ ---
      run: |
        # éå»ã®å¤±æ•—ã§æ®‹ã•ã‚ŒãŸwestè¨­å®šã¨ZMKãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã€ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‚’ä¿è¨¼
        echo "--- DEBUG: Cleaning up old artifacts ---"
        rm -rf .west zmk
        
        # ZMKã‚³ã‚¢ãƒªãƒã‚¸ãƒˆãƒªã‚’æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆä»¥å‰ã®ãƒ“ãƒ«ãƒ‰ã§æˆåŠŸã—ãŸã‚¹ãƒ†ãƒƒãƒ—ï¼‰
        echo "--- DEBUG: Cloning ZMK Core ---"
        git clone --depth 1 https://github.com/zmkfirmware/zmk zmk
        
        # west init ã¨ west update ã§ Zephyr ã‚„ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
        west init -l .
        echo "--- DEBUG: Running west update for remaining dependencies ---"
        west update
        
    - name: Install ZMK Python Dependencies
      run: pip install -r zmk/requirements.txt || true

    # ğŸš¨ æœ€çµ‚ä¿®æ­£: Zephyr SDKã®ç’°å¢ƒè¨­å®šã‚’å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ä»»ã›ã‚‹ ğŸš¨
    # ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã€æ­£ã—ã„ ZEPHYR_SDK_INSTALL_DIR ã‚’è¨­å®šã™ã‚‹ã¯ãšã§ã™ã€‚
    - name: Set up Zephyr environment
      uses: actions/setup-tool-cache@v3 # GitHub Actionsã®æ¨™æº–æ©Ÿèƒ½ã§ãƒ„ãƒ¼ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      with:
        tool: zephyr
        version: '0.16.5' # ZMKã®ç¾åœ¨ã®è¦æ±‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ã¦è¨­å®š

    - name: Build ZMK Firmware
      # west build ã‚’å®Ÿè¡Œã—ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¨­å®šã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
      run: |
        # ZMK/Zephyrç’°å¢ƒã‚’ã‚½ãƒ¼ã‚¹è¨­å®šã—ã¦ã‹ã‚‰ãƒ“ãƒ«ãƒ‰
        source "$HOME/.local/bin/activate" 
        west build -s zmk/app -d build \
          -b seeeduino_xiao_ble \
          -- -DSHIELD=prospector_scanner \
          -DZMK_CONFIG=$GITHUB_WORKSPACE

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: build/zephyr/zmk.uf2
