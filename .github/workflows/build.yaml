# ZMK Custom Config Build Workflow (æ‰‹å‹•ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã‚ˆã‚‹å¼·åˆ¶åˆæœŸåŒ–)

name: Build ZMK Firmware (Manual Toolchain Setup)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ZMK Config and Submodules
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0

    # ğŸš¨ ä¿®æ­£: å¤–éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã›ãšã€GitHub Actions ã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½ã§ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup Toolchain and Python Environment
      run: |
        # Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv git
        python3 -m pip install -U west

    - name: Setup Zephyr SDK (Manual)
      # ğŸš¨ ZMKãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™
      run: |
        echo "ZEPHYR_TOOLCHAIN_VARIANT=zephyr" >> $GITHUB_ENV
        # ZMKã®ãƒ“ãƒ«ãƒ‰ã«å¿…é ˆã¨ãªã‚‹SDKã®ãƒ‘ã‚¹ã‚’ä»®è¨­å®šï¼ˆzmk/appå®Ÿè¡Œæ™‚ã«ä¿®æ­£ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ï¼‰
        # å®Ÿéš›ã«ã¯ã€zmk/app ä»¥ä¸‹ã® west.yml ã§æ­£ã—ã„ SDK ãŒè¨­å®šã•ã‚Œã‚‹ã¯ãšã§ã™ãŒã€ã“ã“ã§ã¯ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚
        echo "ZEPHYR_SDK_INSTALL_DIR=/home/runner/zephyr-sdk-0.16.5" >> $GITHUB_ENV

    - name: --- ğŸš¨ ZMK ã‚³ã‚¢ã®æ‰‹å‹•ã‚¯ãƒ­ãƒ¼ãƒ³ã¨åˆæœŸåŒ– ğŸš¨ ---
      run: |
        # éå»ã®å¤±æ•—ã§æ®‹ã•ã‚ŒãŸwestè¨­å®šã¨ZMKãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
        echo "--- DEBUG: Cleaning up old artifacts ---"
        rm -rf .west zmk
        
        # ZMKã‚³ã‚¢ãƒªãƒã‚¸ãƒˆãƒªã‚’æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€west initãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«å¼·åˆ¶é…ç½®
        echo "--- DEBUG: Cloning ZMK Core ---"
        git clone --depth 1 https://github.com/zmkfirmware/zmk zmk
        
        # west initãŒãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹west.ymlã‚’æ¢ã™ã‚ˆã†æŒ‡ç¤º
        west init -l .
        
        # west updateã‚’å®Ÿè¡Œã—ã€Zephyrã‚„ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
        echo "--- DEBUG: Running west update for remaining dependencies ---"
        west update
        
        if [ ! -d "zmk/app" ]; then
          echo "FATAL: ZMK/APP is still missing after forced clone and west update."
          exit 1
        fi
        
    - name: Install ZMK Python Dependencies
      run: pip install -r zmk/requirements.txt || true

    - name: Build ZMK Firmware
      # west build ã‚’å®Ÿè¡Œã—ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¨­å®šã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
      run: |
        west build -s zmk/app -d build \
          -b seeeduino_xiao_ble \
          -- -DSHIELD=prospector_scanner \
          -DZMK_CONFIG=$GITHUB_WORKSPACE

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: build/zephyr/zmk.uf2
